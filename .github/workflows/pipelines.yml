on:
    push:
        branches:
            - master
            - staging

env:
    APP_NAME: dockerize-laravel

jobs:
    build_and_test:
        runs-on: ubuntu-latest
        steps:
            - name: Check out code
              uses: actions/checkout@v2

            - name: Back up .env.prod
              run: cp .env.prod .env.prod.bak

            - name: Set env ci file
              run: mv -f .env.ci .env.prod
              # We set .env.ci as prod so that, php docker build automatically replaces the current .env.prod to .env while bringing the production docker file up.

            - name: Run docker containers
              run: docker compose -f docker-compose.prod.yml --env-file=.env.prod up -d

            - name: Composer install
              run: docker exec -i ${{ env.APP_NAME }}_app composer install

            - name: Check coding standards
              run: docker exec -i ${{ env.APP_NAME }}_app ./vendor/bin/pint --test

            - name: Run all php tests
              run: docker exec -i ${{ env.APP_NAME }}_app php artisan test

            - name: Revert back env files
              run: mv -f .env.prod .env.ci && mv -f .env.prod.bak .env.prod && rm .env

            - name: Shut down containers
              run: docker compose down

    publish_to_docker_hub:
        runs-on: ubuntu-latest
        needs: build_and_test
        steps:
            - name: List contents
              run: ls -la
